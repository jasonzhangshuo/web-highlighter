# Web Highlighter 修复说明（2026-02-13）

## 1. 问题背景

微信读书场景出现两类问题：

- `http://localhost:3100/dashboard` 偶发被扩展注入干扰。
- 修复重复抓取过程中，出现过“复制后 0 条抓取成功”的回归。

## 2. 本次最终生效的修复

### 修复 A：dashboard 页双保险排除（已生效）

1) 运行时排除（content script 入口直接 return）

- 文件：`extension/content.js`
- 关键点：本地 dashboard 主机名从仅 `localhost` 扩展为 `localhost / 127.0.0.1 / ::1`
- 代码位置：`extension/content.js:8-9`

2) 注入层排除（manifest 不注入 dashboard）

- 文件：`extension/manifest.json`
- 关键点：增加 `exclude_matches`
  - `http://localhost:3100/*`
  - `http://127.0.0.1:3100/*`
- 代码位置：`extension/manifest.json:21-24`

效果：即使打开 dashboard，扩展也不会在该页面执行抓取逻辑，减少误触发和自干扰。

### 修复 B：回滚错误门禁，恢复复制抓取（已生效）

- 文件：`extension/content.js`
- 处理：移除“主页面有 iframe 就跳过 copy 处理”的硬拦截逻辑。
- 原因：该门禁会在部分微信读书页面结构下把唯一有效的 copy 事件也拦掉，导致“1 条都抓不到”。

效果：复制抓取恢复正常，继续依赖已有去重链路（本帧防抖 + storage 去重 + 服务端 60 秒去重）。

## 3. 修复过程中已确认保留的既有逻辑

- 微信读书场景只走“复制即保存”，不做 DOM 扫描。
- 微信读书场景不注入 fetch 拦截脚本。
- 服务端 `POST /api/highlights` 有 `url + text + 60 秒` 去重。

## 4. 复测步骤（可复制）

```bash
# 1) 启动后端服务
cd /Users/dada/gongzhonghaozhuaqu/web-highlighter/server && npm start

# 2) 检查服务是否正常
curl -sS http://localhost:3100/api/stats
```

然后在 Chrome 中执行：

1. 打开 `chrome://extensions`，点击扩展“重新加载”。
2. 打开微信读书页面，执行复制操作，确认 dashboard 有新增记录。
3. 打开 `http://localhost:3100/dashboard` 与 `http://127.0.0.1:3100/dashboard`，确认不被 content script 干扰。

## 5. 变更文件清单

- `extension/content.js`
- `extension/manifest.json`
- `docs/修复说明-2026-02-13.md`（本说明文件）

